<html>
  <head>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.ons.gov.uk/sixteens/81674c0/css/main.css">
  <script src="https://code.highcharts.com/maps/highmaps.js" </script> <script src="https://code.highcharts.com/maps/modules/data.js"></script>
  <script src="https://code.highcharts.com/maps/modules/exporting.js"></script>

  <script src="https://www.google.com/jsapi"></script>
</head>

<body>
  <br><br>
  <div class="wrapper">

    <div class="col-wrap">
    <div class="col col--md-half col--lg-half">
      <div class="wrapper">
        <input type="text" id="geog" name="geog">
        <button class="btn btn--primary btn--thin" onclick="getGeog()">Search location</button>
        <button class="btn btn--secondary btn--thin" onclick="reset()">Reset page</button>
      </div>
        <br>
      <div id="buttons"></div>
    </div>
    <div class="col col--md-half col--lg-half">
        <div id="map" style="min-width: 310px; height: 600px; margin: 0 auto"></div>
    </div>
</div>


  </div>

</body>

<script>
  function reset() {
    location.reload();
  }

  const buttons = document.getElementById('buttons');

  function createNode(element) {
    return document.createElement(element); // Create the type of element you pass in the parameters
  }

  function append(parent, el) {
    return parent.appendChild(el); // Append the second parameter(element) to the first one
  }

  function getGeog() {

    var numResults = 8
    var searchUrl = "http://statistics.data.gov.uk/search.jsonld?page=1&per_page=" + numResults + "&search="
    var searchTerm = document.getElementById("geog").value;

    fetch(searchUrl + searchTerm, {mode: 'cors'}).then(data => data.json()).then(function (data) {

      return data.map(function (variations) {
        //console.log (variations)
        let button = createNode('button'),
          span = createNode('span');
          br = createNode('br');
        button.id = variations["http://www.w3.org/2000/01/rdf-schema#label"]["0"]["@value"];
        button.name = variations["http://statistics.data.gov.uk/def/statistical-geography#officialname"]["0"]["@value"];
        button.onclick = buttonClick;
        span.innerHTML = variations["http://statistics.data.gov.uk/def/statistical-geography#officialname"]["0"]["@value"];
        append(button, span);
        append(buttons, button);
        append(buttons, br);
        button.classList.add("btn"); button.classList.add("btn--primary"); button.classList.add("btn--full-width");

        function buttonClick() {
          //const map = document.getElementById('mapitem');
          var regionID = this.id
          var name = this.name

          fetch("https://opendata.arcgis.com/datasets/2039e084c4e8427981514b2a7fdd077e_3.geojson", {mode: 'cors'}).then(data => data.json()).then(function (data) {

            //let mapitem = data.features[0];
            fetch("http://statistics.data.gov.uk/boundaries/" + regionID + ".json", {mode: 'cors'}).then(data2 => data2.json()).then(function (data2) {

              data.features[1] = data2
              var temp1 = "objectid"
              var temp2 = 2
              data.features[1].properties[temp1] = temp2;

              var fakedata = [
                [
                  '1', 100
                ],
                ['3', 100]
              ];

              Highcharts.mapChart('map', {
                legend: {
                  enabled: false
                },
                credits: {
                  enabled: false
                },
                tooltip: {
                  enabled: false
                },
                interaction: {
                  enabled: false
                },
                mapNavigation: {
                  enabled: true,
                  buttonOptions: {
                    verticalAlign: 'bottom'
                  }
                },
                title: {
                  text: name + " (" + regionID + ")"
                },
                plotOptions: {
                  series: {
                    states: {
                      hover: {
                        enabled: false
                      }
                    }
                  }
                },
                series: [
                  {
                    data: fakedata,
                    mapData: data,
                    joinBy: [
                      'objectid', 0
                    ],
                    color: '#ffffff',
                    keys: ['objectid', 'value']
                  }
                ]
              });
            }).catch(function (error) {
  						alert("Boundary file for this location not yet available, please select another");
  						console.log(error)
  					});
          })
        }
      })
    })
  }
</script>

</html>
